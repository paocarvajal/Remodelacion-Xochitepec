<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Gastos - RemodelaciÃ³n Xochitepec</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        paola: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8'
                        },
                        tere: {
                            50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a', 700: '#15803d'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="text-gray-800 antialiased min-h-screen pb-20">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span class="ml-2 text-xl font-bold text-gray-900 tracking-tight">Gastos Xochitepec <span
                            class="text-xs text-gray-500 font-normal">v2.1</span></span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="app.injectManualTickets()"
                        class="hidden sm:flex items-center px-3 py-2 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 rounded-lg text-sm font-medium transition-colors border border-indigo-200">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                        Descargar Tickets (Reset)
                    </button>
                    <button onclick="app.downloadJSON()"
                        class="p-2 text-gray-500 hover:text-indigo-600 transition-colors"
                        title="Exportar Respaldo JSON">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                    </button>
                    <button onclick="document.getElementById('fileInput').click()"
                        class="p-2 text-gray-500 hover:text-indigo-600 transition-colors"
                        title="Importar Respaldo JSON">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="app.uploadJSON(this)">
                    <div class="h-6 w-px bg-gray-300 mx-2"></div>
                    <button onclick="app.openBulkModal()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-2 rounded-lg font-medium transition flex items-center shadow-lg">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Escanear Ticket
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Dashboard Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Grand Total -->
            <div class="glass-panel rounded-2xl p-6 border-l-4 border-indigo-500">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Gastado</h3>
                    <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-900" id="grand-total">$0.00</p>
                <p class="text-xs text-gray-400 mt-1">Suma total de compras</p>
            </div>

            <!-- Paola Summary -->
            <div class="glass-panel rounded-2xl p-6 border-l-4 border-paola-500">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Paola (Personal)</h3>
                    <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-900" id="paola-total">$0.00</p>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-3">
                    <div class="bg-blue-500 h-1.5 rounded-full" id="paola-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Tere Summary -->
            <div class="glass-panel rounded-2xl p-6 border-l-4 border-tere-500">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Tere (RemodelaciÃ³n)</h3>
                    <div class="p-2 bg-green-50 rounded-lg text-green-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                    </div>
                </div>
                <p class="text-3xl font-bold text-gray-900" id="tere-total">$0.00</p>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-3">
                    <div class="bg-green-500 h-1.5 rounded-full" id="tere-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Balance / Status -->
            <div class="glass-panel rounded-2xl p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Saldo Pendiente</h3>
                    <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3">
                            </path>
                        </svg>
                    </div>
                </div>
                <p class="text-xl font-bold text-gray-800" id="balance-text">Todo pagado</p>
                <p class="text-sm text-gray-500 mt-2" id="balance-detail">Sin deudas pendientes</p>
            </div>
        </div>

        <!-- Add Item Form -->
        <div class="glass-panel rounded-2xl p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Registrar Nuevo Gasto
            </h2>
            <form id="expense-form" class="space-y-6">
                <!-- Row 1: Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Concepto / ArtÃ­culo</label>
                        <input type="text" id="itemName" required placeholder="Ej. Bulto de Cemento"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tienda / Lugar</label>
                        <input type="text" id="storeName" placeholder="Ej. Home Depot" list="stores-list"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition-all">
                        <datalist id="stores-list">
                            <!-- Populated dynamically -->
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pagado Por</label>
                        <select id="paidBy"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="Paola">Paola</option>
                            <option value="Tere">Tere</option>
                        </select>
                    </div>
                </div>

                <!-- Row 2: Price & Quantity -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad Total</label>
                        <input type="number" id="totalQty" required min="1" step="0.01"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                            placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Precio Unitario (con IVA)</label>
                        <div class="relative rounded-md shadow-sm">
                            <div
                                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                $</div>
                            <input type="number" id="unitPrice" required min="0.01" step="0.01"
                                class="pl-7 w-full rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500"
                                placeholder="0.00">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Calculado</label>
                        <div class="relative rounded-md bg-gray-100">
                            <div
                                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-500">
                                $</div>
                            <input type="text" id="totalPrice" readonly
                                class="pl-7 w-full rounded-lg border-transparent bg-transparent text-gray-700 font-semibold"
                                value="0.00">
                        </div>
                    </div>
                    <div class="flex items-end">
                        <input type="date" id="expenseDate" class="w-full rounded-lg border-gray-300 shadow-sm text-sm"
                            required>
                    </div>
                </div>

                <!-- Row 3: Distribution -->
                <div class="border-t border-gray-100 pt-4">
                    <label class="block text-sm font-bold text-gray-700 mb-3">DistribuciÃ³n de Uso</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Paola Side -->
                        <div
                            class="relative bg-blue-50 p-4 rounded-xl border border-blue-100 transition-all hover:shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-blue-900 font-semibold flex items-center">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                    Paola (Personal)
                                </label>
                                <span class="text-xs text-blue-600 font-medium bg-blue-100 px-2 py-1 rounded">Cant:
                                    <span id="disp-qty-paola">0</span></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="qtyPaola" min="0" step="0.01"
                                    class="flex-1 rounded-lg border-blue-200 focus:border-blue-500 focus:ring-blue-500 text-right font-medium"
                                    placeholder="0">
                                <span class="text-gray-400 text-sm">unidades</span>
                            </div>
                            <div class="mt-2 text-right">
                                <span class="text-sm text-gray-500">Costo:</span>
                                <span class="text-lg font-bold text-blue-700" id="costPaola">$0.00</span>
                            </div>
                        </div>

                        <!-- Tere Side -->
                        <div
                            class="relative bg-green-50 p-4 rounded-xl border border-green-100 transition-all hover:shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-green-900 font-semibold flex items-center">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                    Tere (RemodelaciÃ³n)
                                </label>
                                <button type="button" id="btn-assign-tere"
                                    class="text-xs text-green-700 underline hover:text-green-900">Asignar
                                    Restante</button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="qtyTere" min="0" step="0.01"
                                    class="flex-1 rounded-lg border-green-200 focus:border-green-500 focus:ring-green-500 text-right font-medium"
                                    placeholder="0">
                                <span class="text-gray-400 text-sm">unidades</span>
                            </div>
                            <div class="mt-2 text-right">
                                <span class="text-sm text-gray-500">Costo:</span>
                                <span class="text-lg font-bold text-green-700" id="costTere">$0.00</span>
                            </div>
                        </div>
                    </div>
                    <div id="qty-warning" class="hidden mt-2 text-red-500 text-sm flex items-center justify-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                        La suma (Paola + Tere) no coincide con la Cantidad Total
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end pt-4">
                    <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform transition hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        Agregar Gasto
                    </button>
                </div>
            </form>
        </div>

        <!-- Filters & List -->
        <div class="glass-panel rounded-2xl p-6 min-h-[400px]">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                <h2 class="text-lg font-semibold text-gray-800">Historial de Compras</h2>
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Buscar artÃ­culo..."
                            class="pl-9 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full sm:w-64">
                        <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <select id="filterStore"
                        class="rounded-lg border border-gray-300 text-sm focus:ring-indigo-500 focus:border-indigo-500 py-2">
                        <option value="">Todas las tiendas</option>
                    </select>
                    <button onclick="app.confirmClearAll()"
                        class="text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg text-sm font-medium transition-colors border border-transparent hover:border-red-100">
                        Borrar Todo
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-xl border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fecha</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ArtÃ­culo / Tienda</th>
                            <th scope="col"
                                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Cant. Total</th>
                            <th scope="col"
                                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Precio Unit.</th>
                            <th scope="col"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Total</th>
                            <th scope="col"
                                class="px-6 py-3 text-center text-xs font-medium text-paola-600 uppercase tracking-wider bg-blue-50/50">
                                Paola</th>
                            <th scope="col"
                                class="px-6 py-3 text-center text-xs font-medium text-tere-600 uppercase tracking-wider bg-green-50/50">
                                Tere</th>
                            <th scope="col"
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-list" class="bg-white divide-y divide-gray-200">
                        <!-- Items rendered here -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-12 text-center">
                <div class="bg-gray-100 rounded-full p-4 mb-4">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                        </path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Sin gastos registrados</h3>
                <p class="text-gray-500">Agrega el primer artÃ­culo usando el formulario de arriba.</p>
            </div>
        </div>
    </div>

    </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulk-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl">
            <!-- Header -->
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Escaneo Masivo de Tickets (Beta)
                </h3>
                <button onclick="app.closeBulkModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Step 1: Upload -->
                <div class="mb-8 p-6 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 text-center hover:border-indigo-400 transition-colors"
                    id="drop-zone">
                    <input type="file" id="ticketInput" class="hidden" accept="image/*"
                        onchange="app.handleImageUpload(this)">
                    <div id="upload-prompt">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        <p class="text-gray-600 font-medium">Click para subir foto del ticket</p>
                        <p class="text-xs text-gray-400 mt-1">O arrastra la imagen aquÃ­</p>
                        <button onclick="document.getElementById('ticketInput').click()"
                            class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition">Seleccionar
                            Foto</button>
                    </div>

                    <div id="processing-state" class="hidden">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto mb-3">
                        </div>
                        <p class="text-indigo-600 font-medium">Analizando ticket...</p>
                        <p class="text-xs text-gray-500 mt-1" id="ocr-status">Iniciando motor de reconocimiento...</p>
                    </div>
                </div>

                <!-- Staging Table -->
                <div id="staging-area" class="hidden">
                    <div class="flex justify-between items-end mb-3">
                        <h4 class="font-semibold text-gray-700">ArtÃ­culos Detectados</h4>
                        <button onclick="app.addStagingRow()"
                            class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>
                            Agregar Fila Manual
                        </button>
                    </div>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-1/3">
                                        Nombre / Concepto</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-20">
                                        Cant</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase w-24">
                                        Precio</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">
                                        Asignar A</th>
                                    <th class="px-3 py-2 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="staging-list" class="bg-white divide-y divide-gray-200">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 italic">* Revisa bien los precios escaneados antes de
                        confirmar. El OCR puede fallar.</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    <span id="staging-count">0</span> artÃ­culos listos
                </div>
                <div class="space-x-3">
                    <button onclick="app.closeBulkModal()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-lg text-sm font-medium transition">Cancelar</button>
                    <button onclick="app.processStaging()"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 shadow-lg transition flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                        id="btn-import-all" disabled>
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        Registrar Masivamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast"
        class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center">
        <svg class="w-5 h-5 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span id="toast-msg">AcciÃ³n completada</span>
    </div>

    <script>
        class ExpenseTracker {
            constructor() {
                this.expenses = JSON.parse(localStorage.getItem('gst_xoch_data')) || [];
                this.init();
            }

            init() {
                console.log('App Initialized');
                this.cacheDOM();
                this.bindEvents();

                // Auto-load data for new visitors
                if (this.expenses.length === 0) {
                    this.injectManualTickets(true);
                }

                this.render();

                // Set default date to today
                this.dom.expenseDate.valueAsDate = new Date();
            }

            cacheDOM() {
                this.dom = {
                    form: document.getElementById('expense-form'),
                    itemName: document.getElementById('itemName'),
                    storeName: document.getElementById('storeName'),
                    storesList: document.getElementById('stores-list'),
                    paidBy: document.getElementById('paidBy'),
                    totalQty: document.getElementById('totalQty'),
                    unitPrice: document.getElementById('unitPrice'),
                    totalPrice: document.getElementById('totalPrice'),
                    expenseDate: document.getElementById('expenseDate'),

                    qtyPaola: document.getElementById('qtyPaola'),
                    costPaola: document.getElementById('costPaola'),
                    dispQtyPaola: document.getElementById('disp-qty-paola'),

                    qtyTere: document.getElementById('qtyTere'),
                    costTere: document.getElementById('costTere'),
                    btnAssignTere: document.getElementById('btn-assign-tere'),

                    qtyWarning: document.getElementById('qty-warning'),

                    list: document.getElementById('expenses-list'),
                    emptyState: document.getElementById('empty-state'),
                    searchInput: document.getElementById('searchInput'),
                    filterStore: document.getElementById('filterStore'),

                    // Summaries
                    grandTotal: document.getElementById('grand-total'),
                    paolaTotal: document.getElementById('paola-total'),
                    tereTotal: document.getElementById('tere-total'),
                    paolaBar: document.getElementById('paola-bar'),
                    tereBar: document.getElementById('tere-bar'),
                    balanceText: document.getElementById('balance-text'),
                    balanceDetail: document.getElementById('balance-detail'),

                    toast: document.getElementById('toast'),
                    toastMsg: document.getElementById('toast-msg'),

                    // Bulk Modal
                    bulkModal: document.getElementById('bulk-modal'),
                    uploadPrompt: document.getElementById('upload-prompt'),
                    processingState: document.getElementById('processing-state'),
                    ocrStatus: document.getElementById('ocr-status'),
                    stagingArea: document.getElementById('staging-area'),
                    stagingList: document.getElementById('staging-list'),
                    btnImportAll: document.getElementById('btn-import-all'),
                    stagingCount: document.getElementById('staging-count'),
                };
            }

            bindEvents() {
                // Auto calculations
                ['totalQty', 'unitPrice'].forEach(id => {
                    this.dom[id].addEventListener('input', () => this.calcTotals());
                });

                // Distribution logic
                this.dom.qtyPaola.addEventListener('input', () => {
                    this.calcDistribution('paola');
                });
                this.dom.qtyTere.addEventListener('input', () => {
                    this.checkDistributionSum(); // just warn, don't auto change others if manual
                    this.updateCostDisplay();
                });

                this.dom.btnAssignTere.addEventListener('click', () => {
                    const total = parseFloat(this.dom.totalQty.value) || 0;
                    const paola = parseFloat(this.dom.qtyPaola.value) || 0;
                    this.dom.qtyTere.value = Math.max(0, total - paola).toFixed(2);
                    this.updateCostDisplay();
                    this.checkDistributionSum();
                });

                // Form Submit
                this.dom.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit();
                });

                // Filters
                this.dom.searchInput.addEventListener('input', () => this.renderList());
                this.dom.filterStore.addEventListener('change', () => this.renderList());
            }

            calcTotals() {
                const qty = parseFloat(this.dom.totalQty.value) || 0;
                const price = parseFloat(this.dom.unitPrice.value) || 0;
                const total = qty * price;
                this.dom.totalPrice.value = total.toFixed(2);

                this.updateCostDisplay();
                this.checkDistributionSum();
            }

            calcDistribution(source) {
                const total = parseFloat(this.dom.totalQty.value) || 0;
                if (source === 'paola') {
                    // If paola input changes, maybe warn if > total?
                    // User might want to type freely, but let's update cost
                }
                this.updateCostDisplay();
                this.checkDistributionSum();
            }

            updateCostDisplay() {
                const price = parseFloat(this.dom.unitPrice.value) || 0;
                const qP = parseFloat(this.dom.qtyPaola.value) || 0;
                const qT = parseFloat(this.dom.qtyTere.value) || 0;

                this.dom.costPaola.textContent = '$' + (qP * price).toFixed(2);
                this.dom.costTere.textContent = '$' + (qT * price).toFixed(2);
                this.dom.dispQtyPaola.textContent = qP;
            }

            checkDistributionSum() {
                const total = parseFloat(this.dom.totalQty.value) || 0;
                const qP = parseFloat(this.dom.qtyPaola.value) || 0;
                const qT = parseFloat(this.dom.qtyTere.value) || 0;

                // Allow small floating point margin
                if (Math.abs((qP + qT) - total) > 0.01) {
                    this.dom.qtyWarning.classList.remove('hidden');
                    return false;
                } else {
                    this.dom.qtyWarning.classList.add('hidden');
                    return true;
                }
            }

            handleSubmit() {
                if (!this.checkDistributionSum()) {
                    if (!confirm("Las cantidades distribuidas (Paola + Tere) no suman el total. Â¿Guardar de todas formas?")) return;
                }

                const qty = parseFloat(this.dom.totalQty.value);
                const price = parseFloat(this.dom.unitPrice.value);

                const item = {
                    id: this.editingId || Date.now().toString(),
                    date: this.dom.expenseDate.value,
                    name: this.dom.itemName.value,
                    store: this.dom.storeName.value,
                    paidBy: this.dom.paidBy.value,

                    totalQty: qty,
                    unitPrice: price,
                    totalPrice: qty * price,

                    qtyPaola: parseFloat(this.dom.qtyPaola.value) || 0,
                    qtyTere: parseFloat(this.dom.qtyTere.value) || 0,

                    costPaola: (parseFloat(this.dom.qtyPaola.value) || 0) * price,
                    costTere: (parseFloat(this.dom.qtyTere.value) || 0) * price,
                };

                if (this.editingId) {
                    const index = this.expenses.findIndex(e => e.id === this.editingId);
                    if (index !== -1) this.expenses[index] = item;
                    this.showToast("Gasto actualizado correctamente");
                    this.cancelEdit();
                } else {
                    this.expenses.unshift(item);
                    this.showToast("Gasto guardado correctamente");
                    this.dom.form.reset();
                    this.dom.expenseDate.valueAsDate = new Date();
                    this.dom.totalPrice.value = "0.00";
                    this.updateCostDisplay();
                    this.dom.qtyWarning.classList.add('hidden');
                }

                this.save();
                this.render();
            }


            deleteItem(id) {
                if (confirm('Â¿EstÃ¡s segura de borrar este gasto?')) {
                    this.expenses = this.expenses.filter(e => e.id !== id);
                    this.save();
                    this.render();
                    this.showToast("Gasto eliminado");
                }
            }

            save() {
                localStorage.setItem('gst_xoch_data', JSON.stringify(this.expenses));
            }

            render() {
                this.renderList();
                this.renderSummary();
                this.updateMetadata();
            }

            updateMetadata() {
                // Update datalist for stores
                const stores = [...new Set(this.expenses.map(e => e.store).filter(Boolean))].sort();
                this.dom.storesList.innerHTML = stores.map(s => `<option value="${s}">`).join('');

                // Update filter dropdown
                const currentFilter = this.dom.filterStore.value;
                this.dom.filterStore.innerHTML = '<option value="">Todas las tiendas</option>' +
                    stores.map(s => `<option value="${s}">${s}</option>`).join('');
                this.dom.filterStore.value = currentFilter;
            }

            renderList() {
                const search = this.dom.searchInput.value.toLowerCase();
                const filterStore = this.dom.filterStore.value;

                const filtered = this.expenses.filter(e => {
                    const matchSearch = e.name.toLowerCase().includes(search) || (e.store || '').toLowerCase().includes(search);
                    const matchStore = !filterStore || e.store === filterStore;
                    return matchSearch && matchStore;
                });

                if (filtered.length === 0) {
                    this.dom.list.innerHTML = '';
                    this.dom.emptyState.classList.remove('hidden');
                    return;
                }

                this.dom.emptyState.classList.add('hidden');

                this.dom.list.innerHTML = filtered.map(e => `
                    <tr class="hover:bg-gray-50 transition-colors ${this.editingId === e.id ? 'bg-indigo-50 border-l-4 border-indigo-500' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${e.date}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${e.name}</div>
                            <div class="text-xs text-gray-500">${e.store || 'Sin tienda'} â€¢ PagÃ³: <span class="font-semibold ${e.paidBy === 'Paola' ? 'text-blue-600' : 'text-green-600'}">${e.paidBy}</span></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">${e.totalQty}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">${e.unitPrice.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900">${e.totalPrice.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500 bg-blue-50/30">
                            <div class="font-bold text-blue-700">${e.costPaola.toFixed(2)}</div>
                            <div class="text-xs text-gray-400">(${e.qtyPaola})</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500 bg-green-50/30">
                            <div class="font-bold text-green-700">${e.costTere.toFixed(2)}</div>
                            <div class="text-xs text-gray-400">(${e.qtyTere})</div>
                        </td>
                         <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                             <button onclick="app.editItem('${e.id}')" class="text-indigo-400 hover:text-indigo-600" title="Editar / Redistribuir">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button onclick="app.deleteItem('${e.id}')" class="text-red-400 hover:text-red-600" title="Eliminar">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            editItem(id) {
                const item = this.expenses.find(e => e.id === id);
                if (!item) return;

                this.editingId = id;

                // Populate form
                this.dom.itemName.value = item.name;
                this.dom.storeName.value = item.store || '';
                this.dom.paidBy.value = item.paidBy;
                this.dom.totalQty.value = item.totalQty;
                this.dom.unitPrice.value = item.unitPrice;
                this.dom.expenseDate.value = item.date;

                this.dom.qtyPaola.value = item.qtyPaola;
                this.dom.qtyTere.value = item.qtyTere;

                this.calcTotals();

                const btn = this.dom.form.querySelector('button[type="submit"]');
                btn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg> Actualizar Gasto`;
                btn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform transition hover:-translate-y-0.5 focus:outline-none flex items-center";

                let cancelBtn = document.getElementById('btn-cancel-edit');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'btn-cancel-edit';
                    cancelBtn.type = 'button';
                    cancelBtn.className = "ml-4 text-gray-500 hover:text-gray-700 font-medium underline";
                    cancelBtn.textContent = "Cancelar EdiciÃ³n";
                    cancelBtn.onclick = () => this.cancelEdit();
                    btn.parentNode.appendChild(cancelBtn);
                }

                this.dom.itemName.focus();
                this.dom.form.scrollIntoView({ behavior: 'smooth' });
                this.renderList();
            }

            cancelEdit() {
                this.editingId = null;
                this.dom.form.reset();
                this.dom.expenseDate.valueAsDate = new Date();
                this.dom.totalPrice.value = "0.00";

                const btn = this.dom.form.querySelector('button[type="submit"]');
                btn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> Agregar Gasto`;
                btn.className = "bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transform transition hover:-translate-y-0.5 focus:outline-none flex items-center";

                const cancelBtn = document.getElementById('btn-cancel-edit');
                if (cancelBtn) cancelBtn.remove();

                this.updateCostDisplay();
                this.renderList();
            }


            renderSummary() {
                const total = this.expenses.reduce((sum, e) => sum + e.totalPrice, 0);
                const paolaTotal = this.expenses.reduce((sum, e) => sum + e.costPaola, 0);
                const tereTotal = this.expenses.reduce((sum, e) => sum + e.costTere, 0);

                // Who paid what?
                const paolaPaid = this.expenses.filter(e => e.paidBy === 'Paola').reduce((sum, e) => sum + e.totalPrice, 0);
                const terePaid = this.expenses.filter(e => e.paidBy === 'Tere').reduce((sum, e) => sum + e.totalPrice, 0);

                // Balance logic:
                // Paola should have paid: paolaTotal
                // Paola actually paid: paolaPaid
                // Paola balance: paolaPaid - paolaTotal (Positive = needs reimbursement, Negative = owes money)

                // Tere should have paid: tereTotal
                // Tere actually paid: terePaid

                // Net Balance between P and T
                // Let's look at it from Paola's perspective (since she is likely the app owner)
                // "CuÃ¡nto debe pagar cada persona"

                const paolaDiff = paolaPaid - paolaTotal; // If > 0, Paola paid more than her share. Tere owes her.
                // const tereDiff = terePaid - tereTotal; // Should be inverse of paolaDiff approximately (floating point)

                this.dom.grandTotal.textContent = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                this.dom.paolaTotal.textContent = '$' + paolaTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                this.dom.tereTotal.textContent = '$' + tereTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                this.dom.paolaBar.style.width = total ? (paolaTotal / total * 100) + '%' : '0%';
                this.dom.tereBar.style.width = total ? (tereTotal / total * 100) + '%' : '0%';

                if (Math.abs(paolaDiff) < 0.1) {
                    this.dom.balanceText.textContent = "Cuentas Saldadas";
                    this.dom.balanceText.className = "text-xl font-bold text-green-600";
                    this.dom.balanceDetail.textContent = "Nadie debe nada";
                } else if (paolaDiff > 0) {
                    // Paola paid extra, Tere owes Paola
                    this.dom.balanceText.textContent = `Tere debe $${paolaDiff.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    this.dom.balanceText.className = "text-xl font-bold text-paola-600";
                    this.dom.balanceDetail.textContent = "a Paola";
                } else {
                    // Paola paid less than her share, Paola owes Tere
                    this.dom.balanceText.textContent = `Paola debe $${Math.abs(paolaDiff).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    this.dom.balanceText.className = "text-xl font-bold text-tere-600";
                    this.dom.balanceDetail.textContent = "a Tere";
                }
            }

            showToast(msg) {
                this.dom.toastMsg.textContent = msg;
                this.dom.toast.classList.remove('opacity-0');
                setTimeout(() => {
                    this.dom.toast.classList.add('opacity-0');
                }, 3000);
            }

            downloadJSON() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.expenses));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "gastos_xochitepec_" + new Date().toISOString().split('T')[0] + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            uploadJSON(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) {
                            if (confirm("Esto reemplazarÃ¡ todos los datos actuales. Â¿EstÃ¡s segura?")) {
                                this.expenses = json;
                                this.save();
                                this.render();
                                this.showToast("Datos importados correctamente");
                            }
                        } else {
                            alert("El archivo no tiene el formato correcto.");
                        }
                    } catch (err) {
                        alert("Error al leer el archivo JSON");
                    }
                };
                reader.readAsText(file);
                input.value = ''; // reset
            }

            // --- MANUAL TICKET INJECTION (AI ASSISTED) ---
            injectManualTickets(silent = false) {
                // Clear existing expenses as requested ("delete the previous items")
                this.expenses = [];

                const tickets = [
                    // TICKET 1 - PARISINA
                    { date: '2026-01-14', store: 'Parisina', name: 'Plastico pelicula estampado (mts)', qty: 2.5, price: 29.99 },
                    { date: '2026-01-14', store: 'Parisina', name: 'Decoracion papel tapiz (mts)', qty: 10, price: 49.99 },

                    // TICKET 2 - FERREPRECIOS (Precios Netos Calculados con IVA)
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Pistola electrica para pintar 440W', qty: 1, price: 1265.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Claveta articulable de plastico ancho', qty: 8, price: 18.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Llave articulada para plomero 12', qty: 1, price: 175.00 },

                    // TICKET 3 - ELECTRICA EL 45
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Linterna Adir 496 blanca 3 LED recargable', qty: 2, price: 34.45 },

                    // TICKET 4 - FERRETERA 41 (13 Dic 2025)
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Broca avellanador p/madera 7 pzas Adir', qty: 1, price: 103.42 },
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Broca sacabocado madera 8 pzas Adir', qty: 1, price: 111.48 },
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Puntas Adir impacto 5 pzas', qty: 1, price: 39.91 },
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Disco 5 G180 lija 5 pzas Adir', qty: 1, price: 21.34 },
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Mesa de trabajo portatil 60cm', qty: 1, price: 558.62 },

                    // TICKET 5 - FERRETERA 41 (13 Dic 2025)
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Pasador Adir 3" cromo', qty: 1, price: 16.31 },
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Mensula negra 8x1c Adir', qty: 4, price: 8.08 },
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Mensula negra 5x6 Adir', qty: 4, price: 3.92 },
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Remachadora 10 clasica c/60 remaches Santul', qty: 1, price: 108.49 },
                    { date: '2025-12-13', store: 'Ferretera 41', name: 'Aflojatodo 110ml Santul', qty: 1, price: 22.80 },

                    // TICKET 6 - FERREPRECIOS (ACTUALIZADO - Precios Netos)
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Pintura esmalte acrilico aerosol cafe', qty: 2, price: 60.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Rejilla acero inoxidable 5" 3 tornillos', qty: 2, price: 40.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'PortalÃ¡mpara de PVC para intemperie', qty: 4, price: 12.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Rodillo para pintar Felpa 9" rugosa', qty: 1, price: 57.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Guante de latex p/limpieza mediano', qty: 1, price: 26.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Multicontacto triple aterrizado', qty: 1, price: 26.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Plastiprotector 10M uso rudo', qty: 1, price: 23.00 },
                    { date: '2026-01-14', store: 'Ferreprecios', name: 'Repuesto rodillo Felpa 9" extra rugosa', qty: 1, price: 34.00 },

                    // TICKET 7 - ARENCI (Precios Netos)
                    { date: '2026-01-15', store: 'Arenci', name: 'Monomando lavabo cisne 28 inox', qty: 2, price: 510.00 },
                    { date: '2026-01-15', store: 'Arenci', name: 'Llave de paso sin contratuerda', qty: 1, price: 70.00 },

                    // TICKET 8 - FIX FERRETERIAS
                    { date: '2026-01-12', store: 'FIX Ferreterias', name: 'Lona uso rudo 3x4m verde', qty: 1, price: 305.00 },
                    { date: '2026-01-12', store: 'FIX Ferreterias', name: 'Pintura en aerosol cobre metalizado', qty: 1, price: 63.00 },
                    { date: '2026-01-12', store: 'FIX Ferreterias', name: 'Pintura en aerosol gris premium', qty: 4, price: 36.00 },
                    { date: '2026-01-12', store: 'FIX Ferreterias', name: 'Pintura en aerosol negro metalizado', qty: 2, price: 35.00 },
                    { date: '2026-01-12', store: 'FIX Ferreterias', name: 'Linterna de minero LED', qty: 1, price: 65.00 },
                    { date: '2026-01-12', store: 'FIX Ferreterias', name: 'Blister con 4 pilas alcalinas (Pack 1)', qty: 1, price: 21.00 },
                    { date: '2026-01-12', store: 'FIX Ferreterias', name: 'Blister con 4 pilas alcalinas (Pack 2)', qty: 1, price: 23.00 },
                    { date: '2026-01-12', store: 'FIX Ferreterias', name: 'Bolsa ecologica naranja', qty: 1, price: 18.00 },

                    // TICKET 9 - ELECTRICA EL 45
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Cinta Adir 12/6 Teflon 1/4', qty: 2, price: 2.85 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Cinta argos aislante vinil a color', qty: 1, price: 12.85 },

                    // TICKET 10 - HOME DEPOT (Precios Netos)
                    { date: '2026-01-12', store: 'Home Depot', name: 'Conector para lavabo/fregadero', qty: 1, price: 80.31 },
                    { date: '2026-01-12', store: 'Home Depot', name: 'Resistol 5000 lata de 1lt', qty: 1, price: 286.40 },
                    { date: '2026-01-12', store: 'Home Depot', name: 'Pad Paint 7', qty: 1, price: 151.90 },
                    { date: '2026-01-12', store: 'Home Depot', name: 'Rodillo profesional (Pylam) 1 1/4', qty: 1, price: 50.96 },
                    { date: '2026-01-12', store: 'Home Depot', name: 'Triplay construccion CDX 12mm', qty: 1, price: 449.09 },
                    { date: '2026-01-12', store: 'Home Depot', name: 'Marco de obra', qty: 1, price: 105.00 },

                    // TICKET 11 - SUPERMAT (Precios Netos)
                    { date: '2026-01-12', store: 'SuperMat', name: 'Niple acero galvanizado 1/2', qty: 2, price: 7.00 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Adaptador de hule 3/1 1/2 x 2', qty: 3, price: 7.00 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Adaptador de hule 2/1 1/4 x 2', qty: 1, price: 7.00 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Esmalpar negro mate 4lt', qty: 1, price: 613.32 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Cutter alma metalica uso rudo', qty: 1, price: 45.00 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Solvente thinner standar par 1lt', qty: 2, price: 48.00 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Brocha la maestra 1/2', qty: 1, price: 19.00 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Brocha la maestra 2', qty: 1, price: 19.00 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Brocha la maestra 1 1/2', qty: 1, price: 36.89 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Mascarilla con valvula Truper', qty: 1, price: 25.00 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Cinta para empaque canela 50m', qty: 1, price: 75.03 },
                    { date: '2026-01-12', store: 'SuperMat', name: 'Articulo Sin Descripcion', qty: 1, price: 35.00 },

                    // TICKET 12 - ELECTRICA EL 45 (Ticket Grande)
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Cespol Adir 299R flex 1-1/4', qty: 2, price: 30.85 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Pija Adir 13953 #6 1/2', qty: 2, price: 7.45 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Pija Adir 13954 #6 3/4', qty: 4, price: 8.85 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Pija Adir 13955 #6 1', qty: 2, price: 11.60 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Pija Adir 13954 # 1 1/2', qty: 1, price: 21.05 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Arandela Adir 16/25 con abs 4', qty: 2, price: 99.50 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Mezclador Adir 16605 abs fijos', qty: 1, price: 168.90 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Cespol Adir 16200 bote 100mm', qty: 1, price: 71.00 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Coladera Adir 16054 univ', qty: 1, price: 54.25 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Silicon Adir 1534 transpn', qty: 1, price: 15.30 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Llave Adir 423 JR001 nvs', qty: 1, price: 19.50 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Taquete Adir 1711 plast 1/4', qty: 1, price: 7.00 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Taquete Adir 1712 plas 5/16', qty: 1, price: 13.45 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Taquete Adir 1710 ptas 3/16', qty: 1, price: 7.95 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Desarmad Adir 3213 cabinet', qty: 1, price: 10.20 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Llave Adir 425 stilson 8', qty: 1, price: 41.90 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Placa forza mark F20511', qty: 6, price: 37.50 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Placa forza mark F2068SS', qty: 6, price: 32.50 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Reflecto 180T0 50W', qty: 2, price: 120.00 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Foco 180T0 15W LED', qty: 8, price: 13.00 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Extension 180T0 30m', qty: 1, price: 135.50 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Socket 1050 porcela', qty: 2, price: 13.50 },
                    { date: '2026-01-12', store: 'Electrica El 45', name: 'Cable 1050 20m 10aw', qty: 1, price: 199.50 },
                ];

                let count = 0;
                tickets.forEach(t => {
                    const total = t.qty * t.price;
                    const item = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        date: t.date,
                        name: t.name,
                        store: t.store,
                        paidBy: 'Paola',

                        totalQty: t.qty,
                        unitPrice: t.price,
                        totalPrice: total,

                        // Charge ALL to Tere, Paid by Paola
                        qtyPaola: 0,
                        qtyTere: t.qty,

                        costPaola: 0,
                        costTere: total
                    };
                    this.expenses.unshift(item);
                    count++;
                });

                this.save();
                this.render();

                if (!silent) {
                    this.showToast("Lista actualizada y corregida");
                    alert(`Se han reemplazado todos los gastos con los ${count} artículos corregidos. Todo pagado por Paola y cargado a Tere.`);
                }
            }

            confirmClearAll


                () {
                if (confirm("ADVERTENCIA: Â¿EstÃ¡s segura de querer borrar TODO el historial de gastos?\nEsta acciÃ³n no se puede deshacer.")) {
                    this.expenses = [];
                    this.save();
                    this.render();
                    this.showToast("Historial eliminado");
                }
            }

            // --- BULK IMPORT FEATURES ---

            openBulkModal() {
                if (this.dom.bulkModal) {
                    this.dom.bulkModal.classList.remove('hidden');
                    this.dom.bulkModal.classList.add('flex');
                    this.clearBulkState();
                } else {
                    console.error("Bulk Modal DOM element not found");
                }
            }

            closeBulkModal() {
                this.dom.bulkModal.classList.add('hidden');
                this.dom.bulkModal.classList.remove('flex');
            }

            clearBulkState() {
                this.dom.uploadPrompt.classList.remove('hidden');
                this.dom.processingState.classList.add('hidden');
                this.dom.stagingArea.classList.add('hidden');
                this.dom.stagingList.innerHTML = '';
                this.dom.btnImportAll.disabled = true;
                this.dom.stagingCount.textContent = '0';
                document.getElementById('ticketInput').value = '';
                this.dom.ocrStatus.textContent = "Iniciando...";
            }

            async handleImageUpload(input) {
                const file = input.files[0];
                if (!file) return;

                // Show processing UI
                this.dom.uploadPrompt.classList.add('hidden');
                this.dom.processingState.classList.remove('hidden');

                try {
                    this.dom.ocrStatus.textContent = "Cargando motor OCR...";

                    // Check if Tesseract is loaded
                    if (typeof Tesseract === 'undefined') {
                        throw new Error("La librerÃ­a de escaneo no se cargÃ³ correctamente. Verifique su conexiÃ³n a internet.");
                    }

                    this.dom.ocrStatus.textContent = "Escaneando imagen (esto puede tardar)...";

                    // Simple recognize - handles worker creation internally
                    const ret = await Tesseract.recognize(file, 'spa', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                this.dom.ocrStatus.textContent = `Analizando texto: ${(m.progress * 100).toFixed(0)}%`;
                            }
                        }
                    });

                    this.dom.ocrStatus.textContent = "Procesando resultados...";
                    this.parseOCRResult(ret.data.text);

                } catch (err) {
                    console.error(err);
                    alert("Error al procesar la imagen: " + (err.message || err));
                    this.clearBulkState();
                }
            }

            parseOCRResult(text) {
                const lines = text.split('\n').filter(l => l.trim().length > 0);
                const items = [];

                // Regex heuristics
                // Look for lines ending in price: "PRODUCTO X 123.50"
                const priceRegex = /(\$?[\d,]+\.\d{2})/g;

                lines.forEach(line => {
                    let cleanLine = line.replace(/[^\w\s.,$Ã¡Ã©Ã­Ã³ÃºÃ±Ã‘ÃÃ‰ÃÃ“Ãš/-]/g, ' ').trim();
                    const prices = cleanLine.match(priceRegex);

                    if (prices && prices.length > 0) {
                        try {
                            const lastPriceMatch = prices[prices.length - 1];
                            let priceStr = lastPriceMatch.replace('$', '').replace(',', '');
                            let price = parseFloat(priceStr);

                            let name = cleanLine.substring(0, cleanLine.lastIndexOf(lastPriceMatch)).trim();

                            // Cleanup name further
                            name = name.replace(/[\d]+$/, '').trim(); // Remove trailing numbers

                            if (name.length > 2 && price > 0) {
                                items.push({
                                    name: name,
                                    qty: 1,
                                    price: price,
                                    assign: '50/50'
                                });
                            }
                        } catch (e) { console.log("Skipping line", line); }
                    }
                });

                if (items.length === 0) {
                    alert("No se detectaron artÃ­culos claros. Intenta agregar filas manualmente.");
                }

                this.dom.processingState.classList.add('hidden');
                this.dom.stagingArea.classList.remove('hidden');

                items.forEach(item => this.addStagingRow(item));
                this.updateStagingCount();
            }

            addStagingRow(data = null) {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50 transition-colors group";

                const nameVal = data ? data.name : '';
                const qtyVal = data ? data.qty : 1;
                const priceVal = data ? data.price : 0;

                tr.innerHTML = `
                    <td class="px-3 py-2">
                        <input type="text" class="st-name w-full border-gray-200 rounded text-sm focus:ring-indigo-500 focus:border-indigo-500" value="${nameVal}" placeholder="ArtÃ­culo">
                    </td>
                    <td class="px-3 py-2">
                        <input type="number" class="st-qty w-full border-gray-200 rounded text-sm text-center focus:ring-indigo-500 focus:border-indigo-500" value="${qtyVal}" min="1">
                    </td>
                    <td class="px-3 py-2">
                        <input type="number" class="st-price w-full border-gray-200 rounded text-sm text-center focus:ring-indigo-500 focus:border-indigo-500" value="${priceVal}" min="0" step="0.01">
                    </td>
                    <td class="px-3 py-2">
                        <div class="flex bg-gray-100 rounded p-1 justify-between st-assign-group">
                            <button type="button" class="flex-1 text-xs py-1 rounded transition-all ${data?.assign === 'Paola' ? 'bg-blue-500 text-white shadow' : 'text-gray-500 hover:bg-gray-200'}" onclick="app.setAssign(this, 'Paola')">P</button>
                            <button type="button" class="flex-1 text-xs py-1 rounded transition-all ${!data || data?.assign === '50/50' ? 'bg-indigo-500 text-white shadow' : 'text-gray-500 hover:bg-gray-200'}" onclick="app.setAssign(this, '50/50')">Â½</button>
                            <button type="button" class="flex-1 text-xs py-1 rounded transition-all ${data?.assign === 'Tere' ? 'bg-green-500 text-white shadow' : 'text-gray-500 hover:bg-gray-200'}" onclick="app.setAssign(this, 'Tere')">T</button>
                        </div>
                        <input type="hidden" class="st-assign" value="${data?.assign || '50/50'}">
                    </td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="this.closest('tr').remove(); app.updateStagingCount();" class="text-gray-300 hover:text-red-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </td>
                `;
                this.dom.stagingList.appendChild(tr);
                this.updateStagingCount();
            }

            setAssign(btn, type) {
                const group = btn.parentElement;
                const hiddenInput = group.nextElementSibling;

                group.querySelectorAll('button').forEach(b => {
                    b.className = 'flex-1 text-xs py-1 rounded transition-all text-gray-500 hover:bg-gray-200';
                });

                let colorClass = 'bg-indigo-500 text-white shadow';
                if (type === 'Paola') colorClass = 'bg-blue-500 text-white shadow';
                if (type === 'Tere') colorClass = 'bg-green-500 text-white shadow';

                btn.className = `flex-1 text-xs py-1 rounded transition-all ${colorClass}`;
                hiddenInput.value = type;
            }

            updateStagingCount() {
                const count = this.dom.stagingList.children.length;
                this.dom.stagingCount.textContent = count;
                this.dom.btnImportAll.disabled = count === 0;
            }

            processStaging() {
                const rows = this.dom.stagingList.querySelectorAll('tr');
                let addedCount = 0;
                let store = prompt("Â¿De quÃ© tienda son estos tickets? (Opcional)", "Tienda General") || "Varios";

                rows.forEach(row => {
                    const name = row.querySelector('.st-name').value;
                    const qty = parseFloat(row.querySelector('.st-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.st-price').value) || 0;
                    const assign = row.querySelector('.st-assign').value;

                    if (!name || price <= 0) return;

                    const total = qty * price;
                    let qP = 0, qT = 0, cP = 0, cT = 0;

                    if (assign === 'Paola') {
                        qP = qty; cP = total;
                    } else if (assign === 'Tere') {
                        qT = qty; cT = total;
                    } else { // 50/50
                        qP = qty / 2;
                        qT = qty / 2;
                        cP = total / 2;
                        cT = total / 2;
                    }

                    const item = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                        date: new Date().toISOString().split('T')[0],
                        name: name,
                        store: store,
                        paidBy: document.getElementById('paidBy').value || 'Paola',

                        totalQty: qty,
                        unitPrice: price,
                        totalPrice: total,

                        qtyPaola: qP,
                        qtyTere: qT,

                        costPaola: cP,
                        costTere: cT,
                    };

                    this.expenses.unshift(item);
                    addedCount++;
                });

                if (addedCount > 0) {
                    this.save();
                    this.render();
                    this.closeBulkModal();
                    this.showToast(`${addedCount} artÃ­culos registrados correctamente`);
                } else {
                    alert("No hay artÃ­culos vÃ¡lidos para agregar.");
                }
            }
        }

        // Initialize App
        const app = new ExpenseTracker();
    </script>
</body>

</html>